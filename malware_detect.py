# -*- coding: utf-8 -*- 
from pyfsig.file_signatures import signatures
from pyfsig.file_signatures import Signature, Matches, NoMatchException
from pyfsig.file_signatures import compare_sig, get_from_file, get_from_path

from vba_parser_and_detect.vba_macro_parser import Extract_VBA
from vba_parser_and_detect.detect_mal_vba import MalFunc, find_malicious_code_from_vba

import check_file_type.find_file_type

import sys
import os 
OOXML = "50 4B 03 04"                  #pptx, docx, xlsx
OLECF = "D0 CF 11 E0 A1 B1 1A E1"      #ppt, xls, doc, hwp
PDF = "25 50 44 46"                    #pdf

f_name = sys.argv[1]
# returns a Match object (list of signatures) that match the file 'f'

try:
   abs_f_name = os.path.abspath(f_name)
   with open("a.hwp", "rb") as f:
      __file_signatures = get_from_file(f)
except Exception as e:
   print(f"d{abs_f_name}")
   print(e)

print(f"result : {__file_signatures}[0]")
if __file_signatures[0]['hex'] == OOXML:                          #if file_extension is ooxml
   #extensions =[file_signature['file_extension'] for file_signature in file_signatures]
   #print(extensions)
   vba_code = Extract_VBA(f_name)
   if vba_code:
      find_malicious_code_from_vba(vba_code)
   else:
      pass
elif __file_signatures[0]['hex'] == OLECF:                          #if file_extension is olecf
   #extensions =[file_signature['file_extension'] for file_signature in file_signatures]
   if check_file_type.find_file_type.get_file_type(f_name) == 'HWP':
      print("!!!!")
      pass  #스크립트 처리 함수 호출
   elif check_file_type.find_file_type.get_file_type(f_name) in ['DOC', 'PPT', 'XLS']:
      vba_code = Extract_VBA(f_name)
      if vba_code:
         find_malicious_code_from_vba(vba_code)
      else:
         pass
   
elif __file_signatures[0]['hex'] == PDF:                          #if file_extension is pdf
   #extensions =[file_signature['file_extension'] for file_signature in file_signatures]
   print("pdfasd")
else:
   print("this file is Out of inspection target.")


